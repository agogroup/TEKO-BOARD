# TEKO-BOARD データベース設計書

**バージョン**: 1.0
**作成日**: 2025年12月17日
**最終更新**: 2025年12月17日

---

## 1. 概要

TEKO-BOARDはAGORAと同一のSupabaseプロジェクトを共有し、専用テーブル（`teko_` プレフィックス）を追加して運用します。

### 1.1 テーブル構成

| カテゴリ | テーブル | 説明 |
|---------|---------|------|
| **共有** | users | ユーザー（AGORA共通） |
| **共有** | clients | クライアント（AGORA共通） |
| **TEKO専用** | teko_workers | ワーカー（職人・作業員） |
| **TEKO専用** | teko_sites | 現場（配置先） |
| **TEKO専用** | teko_assignments | 配置スケジュール |
| **TEKO専用** | teko_contacts | 連絡先（会社・業者） |
| **ビュー** | teko_daily_schedule | 日別スケジュールビュー |

---

## 2. ER図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              TEKO-BOARD ER図                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

【共有テーブル（AGORAで定義済み）】

┌──────────────┐                        ┌──────────────┐
│    users     │                        │   clients    │
├──────────────┤                        ├──────────────┤
│ id (PK)      │                        │ id (PK)      │
│ email        │                        │ name         │
│ name         │                        │ contact_name │
│ role         │                        │ phone        │
│ avatar_url   │                        │ email        │
│ phone        │                        │ address      │
│ is_active    │                        │ notes        │
│ created_at   │                        │ created_at   │
│ updated_at   │                        │ updated_at   │
└──────────────┘                        └──────────────┘
       │                                       │
       │                                       │
       │    【TEKO専用テーブル】               │
       │                                       │
       │    ┌──────────────────┐               │
       │    │  teko_workers    │               │
       │    ├──────────────────┤               │
       │    │ id (PK)          │               │
       │    │ name             │               │
       │    │ company_name     │               │
       │    │ phone            │               │
       │    │ email            │               │
       │    │ skills[]         │               │
       │    │ notes            │               │
       │    │ is_active        │               │
       │    │ created_at       │               │
       │    │ updated_at       │               │
       │    └────────┬─────────┘               │
       │             │                         │
       │             │                         │
       │             │    ┌──────────────────┐ │
       │             │    │   teko_sites     │ │
       │             │    ├──────────────────┤ │
       │             │    │ id (PK)          │ │
       │             │    │ name             │ │
       │             │    │ address          │ │
       │             │    │ client_id (FK)   │─┘
       │             │    │ project_id (FK)  │──▶ projects (AGORA)
       │             │    │ notes            │
       │             │    │ is_active        │
       │             │    │ created_at       │
       │             │    │ updated_at       │
       │             │    └────────┬─────────┘
       │             │             │
       │             │             │
       │             ▼             ▼
       │    ┌──────────────────────────────┐
       │    │      teko_assignments        │
       │    ├──────────────────────────────┤
       │    │ id (PK)                      │
       │    │ worker_id (FK)  ─────────────┼──▶ teko_workers
       │    │ site_id (FK)    ─────────────┼──▶ teko_sites
       │    │ date                         │
       │    │ start_time                   │
       │    │ end_time                     │
       │    │ work_type                    │
       │    │ status                       │
       │    │ notes                        │
       │    │ created_by (FK) ─────────────┼──▶ users
       │    │ created_at                   │
       └────┼──────────────────────────────┘
            │ updated_at
            │
            │
       ┌────────────────────┐
       │   teko_contacts    │
       ├────────────────────┤
       │ id (PK)            │
       │ company_name       │
       │ contact_name       │
       │ phone              │
       │ email              │
       │ category           │
       │ notes              │
       │ created_at         │
       │ updated_at         │
       └────────────────────┘


【AGORA連携】

┌──────────────────┐
│    projects      │  ← AGORAテーブル
├──────────────────┤
│ id (PK)          │
│ name             │◀── teko_sites.project_id で参照
│ ...              │
└──────────────────┘
```

---

## 3. テーブル定義

### 3.1 共有テーブル（参照のみ）

共有テーブルはAGORAで定義済みです。TEKO-BOARDからは参照のみ行います。

#### users（ユーザー）

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| id | uuid | NOT NULL | 主キー（Supabase Auth連携） |
| email | varchar(255) | NOT NULL | メールアドレス |
| name | varchar(100) | NOT NULL | 表示名 |
| role | user_role | NOT NULL | ロール（admin/manager/member/partner） |
| is_active | boolean | NOT NULL | アクティブフラグ |

#### clients（クライアント）

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| id | uuid | NOT NULL | 主キー |
| name | varchar(200) | NOT NULL | 会社名 |
| contact_name | varchar(100) | NULL | 担当者名 |
| phone | varchar(20) | NULL | 電話番号 |

---

### 3.2 teko_workers（ワーカー）

職人・作業員の情報を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | gen_random_uuid() | 主キー |
| name | varchar(100) | NOT NULL | - | 名前 |
| company_name | varchar(200) | NULL | - | 所属会社名 |
| phone | varchar(20) | NULL | - | 電話番号 |
| email | varchar(255) | NULL | - | メールアドレス |
| skills | text[] | NULL | - | スキル（作業種別配列） |
| notes | text | NULL | - | 備考 |
| is_active | boolean | NOT NULL | true | アクティブフラグ |
| created_at | timestamptz | NOT NULL | now() | 作成日時 |
| updated_at | timestamptz | NOT NULL | now() | 更新日時 |

**インデックス:**
- PRIMARY KEY (id)
- INDEX (company_name)
- INDEX (is_active)

**サンプルデータ:**
```sql
INSERT INTO teko_workers (name, company_name, skills) VALUES
  ('TEKO', 'UGOKU株式会社', ARRAY['garbage']),
  ('トラ（堀川寿人）', 'Tiger Management', ARRAY['management']),
  ('三十興業', '三十興業', ARRAY['interior', 'light_steel', 'board', 'wallpaper']),
  ('S-TEC', 'S-TEC', ARRAY['demolition']),
  ('神城電気', '神城電気', ARRAY['electrical']);
```

---

### 3.3 teko_sites（現場）

配置先の現場情報を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | gen_random_uuid() | 主キー |
| name | varchar(200) | NOT NULL | - | 現場名 |
| address | text | NULL | - | 住所 |
| client_id | uuid | NULL | - | クライアントID（共有テーブル参照） |
| project_id | uuid | NULL | - | AGORA案件ID（連携用） |
| notes | text | NULL | - | 備考 |
| is_active | boolean | NOT NULL | true | アクティブフラグ |
| created_at | timestamptz | NOT NULL | now() | 作成日時 |
| updated_at | timestamptz | NOT NULL | now() | 更新日時 |

**インデックス:**
- PRIMARY KEY (id)
- INDEX (client_id)
- INDEX (project_id)
- INDEX (is_active)

**外部キー:**
- client_id → clients(id) ON DELETE SET NULL
- project_id → projects(id) ON DELETE SET NULL

**サンプルデータ:**
```sql
INSERT INTO teko_sites (name, address) VALUES
  ('宇都宮ソフトバンク', '宇都宮市○○町1-2-3'),
  ('クレープ屋', '東京都渋谷区○○1-1'),
  ('赤羽居酒屋', '東京都北区赤羽○○'),
  ('町屋', '東京都荒川区町屋○○');
```

---

### 3.4 teko_assignments（配置スケジュール）

ワーカーの現場への配置スケジュールを管理するテーブル。タイムチャートの元データ。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | gen_random_uuid() | 主キー |
| worker_id | uuid | NOT NULL | - | ワーカーID |
| site_id | uuid | NOT NULL | - | 現場ID |
| date | date | NOT NULL | - | 配置日 |
| start_time | time | NULL | - | 開始時間 |
| end_time | time | NULL | - | 終了時間 |
| work_type | work_type | NOT NULL | 'other' | 作業種別 |
| status | assignment_status | NOT NULL | 'scheduled' | ステータス |
| notes | text | NULL | - | 備考 |
| created_by | uuid | NULL | - | 作成者ID |
| created_at | timestamptz | NOT NULL | now() | 作成日時 |
| updated_at | timestamptz | NOT NULL | now() | 更新日時 |

**インデックス:**
- PRIMARY KEY (id)
- INDEX (worker_id)
- INDEX (site_id)
- INDEX (date)
- INDEX (worker_id, date) -- タイムチャート用複合インデックス
- INDEX (site_id, date)

**外部キー:**
- worker_id → teko_workers(id) ON DELETE CASCADE
- site_id → teko_sites(id) ON DELETE CASCADE
- created_by → users(id) ON DELETE SET NULL

**ENUM: work_type（作業種別）**
```sql
CREATE TYPE work_type AS ENUM (
  'garbage',      -- ゴミ回収
  'management',   -- 現場管理
  'interior',     -- 内装工事（一般）
  'light_steel',  -- 軽量鉄骨
  'board',        -- ボード
  'wallpaper',    -- クロス
  'tile_carpet',  -- タイルカーペット
  'demolition',   -- 解体
  'electrical',   -- 電気工事
  'other'         -- その他
);
```

**ENUM: assignment_status（配置ステータス）**
```sql
CREATE TYPE assignment_status AS ENUM (
  'scheduled',    -- 予定
  'confirmed',    -- 確定
  'in_progress',  -- 作業中
  'completed',    -- 完了
  'cancelled'     -- キャンセル
);
```

---

### 3.5 teko_contacts（連絡先）

協力業者・会社の連絡先を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | uuid | NOT NULL | gen_random_uuid() | 主キー |
| company_name | varchar(200) | NOT NULL | - | 会社名 |
| contact_name | varchar(100) | NULL | - | 担当者名 |
| phone | varchar(20) | NULL | - | 電話番号 |
| email | varchar(255) | NULL | - | メールアドレス |
| category | varchar(50) | NULL | - | カテゴリ（作業種別） |
| notes | text | NULL | - | 備考 |
| created_at | timestamptz | NOT NULL | now() | 作成日時 |
| updated_at | timestamptz | NOT NULL | now() | 更新日時 |

**インデックス:**
- PRIMARY KEY (id)
- INDEX (company_name)
- INDEX (category)

**サンプルデータ:**
```sql
INSERT INTO teko_contacts (company_name, contact_name, phone, category) VALUES
  ('三十興業', '三十さん', '090-XXXX-XXXX', 'interior'),
  ('S-TEC', '佐藤さん', '090-XXXX-XXXX', 'demolition'),
  ('神城電気', '神城さん', '090-XXXX-XXXX', 'electrical'),
  ('Tiger Management', '堀川寿人', '090-XXXX-XXXX', 'management');
```

---

## 4. ビュー定義

### 4.1 teko_daily_schedule（日別スケジュールビュー）

タイムチャート表示用に、日別のスケジュールを展開したビュー。

```sql
CREATE VIEW teko_daily_schedule AS
SELECT
  a.id AS assignment_id,
  a.date,
  a.start_time,
  a.end_time,
  a.work_type,
  a.status,
  a.notes AS assignment_notes,
  w.id AS worker_id,
  w.name AS worker_name,
  w.company_name AS worker_company,
  s.id AS site_id,
  s.name AS site_name,
  s.address AS site_address,
  s.project_id
FROM teko_assignments a
JOIN teko_workers w ON a.worker_id = w.id
JOIN teko_sites s ON a.site_id = s.id
WHERE w.is_active = true
  AND s.is_active = true
ORDER BY a.date, w.company_name, a.start_time;
```

**使用例:**
```sql
-- 特定日のスケジュール取得
SELECT * FROM teko_daily_schedule WHERE date = '2025-12-17';

-- 特定週のスケジュール取得
SELECT * FROM teko_daily_schedule
WHERE date BETWEEN '2025-12-16' AND '2025-12-22';

-- 特定ワーカーのスケジュール取得
SELECT * FROM teko_daily_schedule
WHERE worker_id = 'xxx' AND date = '2025-12-17';
```

---

### 4.2 teko_worker_availability（ワーカー空き状況ビュー）

Phase 2用：ワーカーの空き状況を確認するビュー。

```sql
CREATE VIEW teko_worker_availability AS
SELECT
  w.id AS worker_id,
  w.name AS worker_name,
  w.company_name,
  d.date,
  CASE
    WHEN a.id IS NULL THEN 'available'
    WHEN SUM(EXTRACT(EPOCH FROM (a.end_time - a.start_time))) / 3600 < 8 THEN 'partial'
    ELSE 'busy'
  END AS availability,
  COALESCE(SUM(EXTRACT(EPOCH FROM (a.end_time - a.start_time))) / 3600, 0) AS scheduled_hours
FROM teko_workers w
CROSS JOIN (
  SELECT generate_series(
    CURRENT_DATE,
    CURRENT_DATE + INTERVAL '30 days',
    INTERVAL '1 day'
  )::date AS date
) d
LEFT JOIN teko_assignments a ON w.id = a.worker_id
  AND a.date = d.date
  AND a.status != 'cancelled'
WHERE w.is_active = true
GROUP BY w.id, w.name, w.company_name, d.date, a.id
ORDER BY d.date, w.company_name;
```

---

## 5. 作業種別カラー設定

フロントエンドで使用する作業種別とカラーの対応。

| work_type | 表示名 | カラー | カラーコード |
|-----------|--------|--------|--------------|
| garbage | ゴミ回収 | 青 | #3B82F6 |
| management | 現場管理 | 緑 | #22C55E |
| interior | 内装工事 | オレンジ | #F97316 |
| light_steel | 軽量鉄骨 | オレンジ | #F97316 |
| board | ボード | オレンジ | #F97316 |
| wallpaper | クロス | オレンジ | #F97316 |
| tile_carpet | タイルカーペット | オレンジ | #F97316 |
| demolition | 解体 | 赤 | #EF4444 |
| electrical | 電気工事 | 黄 | #EAB308 |
| other | その他 | グレー | #6B7280 |

**フロントエンド定数定義:**
```typescript
export const WORK_TYPE_CONFIG: Record<WorkType, { label: string; color: string }> = {
  garbage: { label: 'ゴミ回収', color: '#3B82F6' },
  management: { label: '現場管理', color: '#22C55E' },
  interior: { label: '内装工事', color: '#F97316' },
  light_steel: { label: '軽量鉄骨', color: '#F97316' },
  board: { label: 'ボード', color: '#F97316' },
  wallpaper: { label: 'クロス', color: '#F97316' },
  tile_carpet: { label: 'タイルカーペット', color: '#F97316' },
  demolition: { label: '解体', color: '#EF4444' },
  electrical: { label: '電気工事', color: '#EAB308' },
  other: { label: 'その他', color: '#6B7280' },
};
```

---

## 6. RLSポリシー

### 6.1 teko_workers

```sql
ALTER TABLE teko_workers ENABLE ROW LEVEL SECURITY;

-- SELECT: 認証済みユーザー全員
CREATE POLICY "select_teko_workers" ON teko_workers
  FOR SELECT USING (auth.uid() IS NOT NULL);

-- INSERT: manager以上
CREATE POLICY "insert_teko_workers" ON teko_workers
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager')
    )
  );

-- UPDATE: manager以上
CREATE POLICY "update_teko_workers" ON teko_workers
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager')
    )
  );

-- DELETE: admin のみ
CREATE POLICY "delete_teko_workers" ON teko_workers
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

### 6.2 teko_sites

```sql
ALTER TABLE teko_sites ENABLE ROW LEVEL SECURITY;

-- SELECT: 認証済みユーザー全員
CREATE POLICY "select_teko_sites" ON teko_sites
  FOR SELECT USING (auth.uid() IS NOT NULL);

-- INSERT: member以上
CREATE POLICY "insert_teko_sites" ON teko_sites
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member')
    )
  );

-- UPDATE: member以上
CREATE POLICY "update_teko_sites" ON teko_sites
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member')
    )
  );

-- DELETE: manager以上
CREATE POLICY "delete_teko_sites" ON teko_sites
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager')
    )
  );
```

### 6.3 teko_assignments

```sql
ALTER TABLE teko_assignments ENABLE ROW LEVEL SECURITY;

-- SELECT: 認証済みユーザー全員
CREATE POLICY "select_teko_assignments" ON teko_assignments
  FOR SELECT USING (auth.uid() IS NOT NULL);

-- INSERT: member以上
CREATE POLICY "insert_teko_assignments" ON teko_assignments
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member')
    )
  );

-- UPDATE: member以上
CREATE POLICY "update_teko_assignments" ON teko_assignments
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member')
    )
  );

-- DELETE: manager以上
CREATE POLICY "delete_teko_assignments" ON teko_assignments
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager')
    )
  );
```

### 6.4 teko_contacts

```sql
ALTER TABLE teko_contacts ENABLE ROW LEVEL SECURITY;

-- SELECT: 認証済みユーザー全員
CREATE POLICY "select_teko_contacts" ON teko_contacts
  FOR SELECT USING (auth.uid() IS NOT NULL);

-- INSERT: member以上
CREATE POLICY "insert_teko_contacts" ON teko_contacts
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member')
    )
  );

-- UPDATE: member以上
CREATE POLICY "update_teko_contacts" ON teko_contacts
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member')
    )
  );

-- DELETE: manager以上
CREATE POLICY "delete_teko_contacts" ON teko_contacts
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager')
    )
  );
```

---

## 7. マイグレーション

### 7.1 TEKOテーブル追加マイグレーション

```sql
-- supabase/migrations/YYYYMMDD_add_teko_tables.sql

-- =============================================================================
-- ENUM Types
-- =============================================================================

-- 作業種別
CREATE TYPE work_type AS ENUM (
  'garbage',
  'management',
  'interior',
  'light_steel',
  'board',
  'wallpaper',
  'tile_carpet',
  'demolition',
  'electrical',
  'other'
);

-- 配置ステータス
CREATE TYPE assignment_status AS ENUM (
  'scheduled',
  'confirmed',
  'in_progress',
  'completed',
  'cancelled'
);

-- =============================================================================
-- Tables
-- =============================================================================

-- ワーカー（職人・作業員）
CREATE TABLE teko_workers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  company_name VARCHAR(200),
  phone VARCHAR(20),
  email VARCHAR(255),
  skills TEXT[],
  notes TEXT,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 現場（配置先）
CREATE TABLE teko_sites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  address TEXT,
  client_id UUID REFERENCES clients(id) ON DELETE SET NULL,
  project_id UUID REFERENCES projects(id) ON DELETE SET NULL,
  notes TEXT,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 配置スケジュール
CREATE TABLE teko_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  worker_id UUID NOT NULL REFERENCES teko_workers(id) ON DELETE CASCADE,
  site_id UUID NOT NULL REFERENCES teko_sites(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  start_time TIME,
  end_time TIME,
  work_type work_type NOT NULL DEFAULT 'other',
  status assignment_status NOT NULL DEFAULT 'scheduled',
  notes TEXT,
  created_by UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 連絡先（会社・業者）
CREATE TABLE teko_contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_name VARCHAR(200) NOT NULL,
  contact_name VARCHAR(100),
  phone VARCHAR(20),
  email VARCHAR(255),
  category VARCHAR(50),
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- Indexes
-- =============================================================================

CREATE INDEX idx_teko_workers_company_name ON teko_workers(company_name);
CREATE INDEX idx_teko_workers_is_active ON teko_workers(is_active);

CREATE INDEX idx_teko_sites_client_id ON teko_sites(client_id);
CREATE INDEX idx_teko_sites_project_id ON teko_sites(project_id);
CREATE INDEX idx_teko_sites_is_active ON teko_sites(is_active);

CREATE INDEX idx_teko_assignments_worker_id ON teko_assignments(worker_id);
CREATE INDEX idx_teko_assignments_site_id ON teko_assignments(site_id);
CREATE INDEX idx_teko_assignments_date ON teko_assignments(date);
CREATE INDEX idx_teko_assignments_worker_date ON teko_assignments(worker_id, date);
CREATE INDEX idx_teko_assignments_site_date ON teko_assignments(site_id, date);

CREATE INDEX idx_teko_contacts_company_name ON teko_contacts(company_name);
CREATE INDEX idx_teko_contacts_category ON teko_contacts(category);

-- =============================================================================
-- Triggers
-- =============================================================================

-- updated_at 自動更新トリガー
CREATE OR REPLACE FUNCTION teko_update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_teko_workers_updated_at
  BEFORE UPDATE ON teko_workers
  FOR EACH ROW EXECUTE FUNCTION teko_update_updated_at();

CREATE TRIGGER update_teko_sites_updated_at
  BEFORE UPDATE ON teko_sites
  FOR EACH ROW EXECUTE FUNCTION teko_update_updated_at();

CREATE TRIGGER update_teko_assignments_updated_at
  BEFORE UPDATE ON teko_assignments
  FOR EACH ROW EXECUTE FUNCTION teko_update_updated_at();

CREATE TRIGGER update_teko_contacts_updated_at
  BEFORE UPDATE ON teko_contacts
  FOR EACH ROW EXECUTE FUNCTION teko_update_updated_at();

-- =============================================================================
-- Views
-- =============================================================================

CREATE VIEW teko_daily_schedule AS
SELECT
  a.id AS assignment_id,
  a.date,
  a.start_time,
  a.end_time,
  a.work_type,
  a.status,
  a.notes AS assignment_notes,
  w.id AS worker_id,
  w.name AS worker_name,
  w.company_name AS worker_company,
  s.id AS site_id,
  s.name AS site_name,
  s.address AS site_address,
  s.project_id
FROM teko_assignments a
JOIN teko_workers w ON a.worker_id = w.id
JOIN teko_sites s ON a.site_id = s.id
WHERE w.is_active = true
  AND s.is_active = true
ORDER BY a.date, w.company_name, a.start_time;

-- =============================================================================
-- RLS Policies
-- =============================================================================

-- teko_workers
ALTER TABLE teko_workers ENABLE ROW LEVEL SECURITY;

CREATE POLICY "select_teko_workers" ON teko_workers
  FOR SELECT USING (auth.uid() IS NOT NULL);

CREATE POLICY "insert_teko_workers" ON teko_workers
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager'))
  );

CREATE POLICY "update_teko_workers" ON teko_workers
  FOR UPDATE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager'))
  );

CREATE POLICY "delete_teko_workers" ON teko_workers
  FOR DELETE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin')
  );

-- teko_sites
ALTER TABLE teko_sites ENABLE ROW LEVEL SECURITY;

CREATE POLICY "select_teko_sites" ON teko_sites
  FOR SELECT USING (auth.uid() IS NOT NULL);

CREATE POLICY "insert_teko_sites" ON teko_sites
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member'))
  );

CREATE POLICY "update_teko_sites" ON teko_sites
  FOR UPDATE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member'))
  );

CREATE POLICY "delete_teko_sites" ON teko_sites
  FOR DELETE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager'))
  );

-- teko_assignments
ALTER TABLE teko_assignments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "select_teko_assignments" ON teko_assignments
  FOR SELECT USING (auth.uid() IS NOT NULL);

CREATE POLICY "insert_teko_assignments" ON teko_assignments
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member'))
  );

CREATE POLICY "update_teko_assignments" ON teko_assignments
  FOR UPDATE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member'))
  );

CREATE POLICY "delete_teko_assignments" ON teko_assignments
  FOR DELETE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager'))
  );

-- teko_contacts
ALTER TABLE teko_contacts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "select_teko_contacts" ON teko_contacts
  FOR SELECT USING (auth.uid() IS NOT NULL);

CREATE POLICY "insert_teko_contacts" ON teko_contacts
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member'))
  );

CREATE POLICY "update_teko_contacts" ON teko_contacts
  FOR UPDATE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member'))
  );

CREATE POLICY "delete_teko_contacts" ON teko_contacts
  FOR DELETE USING (
    EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND role IN ('admin', 'manager'))
  );
```

---

## 8. シードデータ

```sql
-- supabase/seed_teko.sql

-- =============================================================================
-- サンプルワーカー
-- =============================================================================
INSERT INTO teko_workers (id, name, company_name, skills, phone) VALUES
  ('w0000001-0000-0000-0000-000000000001', 'TEKO', 'UGOKU株式会社', ARRAY['garbage']::text[], '090-0000-0001'),
  ('w0000001-0000-0000-0000-000000000002', 'トラ（堀川寿人）', 'Tiger Management', ARRAY['management']::text[], '090-0000-0002'),
  ('w0000001-0000-0000-0000-000000000003', '三十興業', '三十興業', ARRAY['interior', 'light_steel', 'board', 'wallpaper']::text[], '090-0000-0003'),
  ('w0000001-0000-0000-0000-000000000004', 'S-TEC', 'S-TEC', ARRAY['demolition']::text[], '090-0000-0004'),
  ('w0000001-0000-0000-0000-000000000005', '神城電気', '神城電気', ARRAY['electrical']::text[], '090-0000-0005');

-- =============================================================================
-- サンプル現場
-- =============================================================================
INSERT INTO teko_sites (id, name, address) VALUES
  ('s0000001-0000-0000-0000-000000000001', '宇都宮ソフトバンク', '宇都宮市○○町1-2-3'),
  ('s0000001-0000-0000-0000-000000000002', 'クレープ屋', '東京都渋谷区○○1-1'),
  ('s0000001-0000-0000-0000-000000000003', '赤羽居酒屋', '東京都北区赤羽○○'),
  ('s0000001-0000-0000-0000-000000000004', '町屋', '東京都荒川区町屋○○');

-- =============================================================================
-- サンプル配置スケジュール
-- =============================================================================
INSERT INTO teko_assignments (worker_id, site_id, date, start_time, end_time, work_type) VALUES
  ('w0000001-0000-0000-0000-000000000001', 's0000001-0000-0000-0000-000000000001', CURRENT_DATE, '09:00', '12:00', 'garbage'),
  ('w0000001-0000-0000-0000-000000000001', 's0000001-0000-0000-0000-000000000004', CURRENT_DATE, '14:00', '17:00', 'garbage'),
  ('w0000001-0000-0000-0000-000000000002', 's0000001-0000-0000-0000-000000000001', CURRENT_DATE, '09:00', '18:00', 'management'),
  ('w0000001-0000-0000-0000-000000000003', 's0000001-0000-0000-0000-000000000003', CURRENT_DATE, '13:00', '20:00', 'interior'),
  ('w0000001-0000-0000-0000-000000000004', 's0000001-0000-0000-0000-000000000004', CURRENT_DATE, '08:00', '15:00', 'demolition'),
  ('w0000001-0000-0000-0000-000000000005', 's0000001-0000-0000-0000-000000000004', CURRENT_DATE, '14:00', '18:00', 'electrical');

-- =============================================================================
-- サンプル連絡先
-- =============================================================================
INSERT INTO teko_contacts (company_name, contact_name, phone, category) VALUES
  ('三十興業', '三十さん', '090-0000-0003', 'interior'),
  ('S-TEC', '佐藤さん', '090-0000-0004', 'demolition'),
  ('神城電気', '神城さん', '090-0000-0005', 'electrical'),
  ('Tiger Management', '堀川寿人', '090-0000-0002', 'management'),
  ('UGOKU株式会社', '染谷雅人', '090-0000-0001', 'garbage');
```

---

## 9. TypeScript型定義

```typescript
// src/types/database.ts

export type WorkType =
  | 'garbage'
  | 'management'
  | 'interior'
  | 'light_steel'
  | 'board'
  | 'wallpaper'
  | 'tile_carpet'
  | 'demolition'
  | 'electrical'
  | 'other';

export type AssignmentStatus =
  | 'scheduled'
  | 'confirmed'
  | 'in_progress'
  | 'completed'
  | 'cancelled';

export interface TekoWorker {
  id: string;
  name: string;
  company_name: string | null;
  phone: string | null;
  email: string | null;
  skills: string[] | null;
  notes: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface TekoSite {
  id: string;
  name: string;
  address: string | null;
  client_id: string | null;
  project_id: string | null;
  notes: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface TekoAssignment {
  id: string;
  worker_id: string;
  site_id: string;
  date: string; // YYYY-MM-DD
  start_time: string | null; // HH:mm:ss
  end_time: string | null; // HH:mm:ss
  work_type: WorkType;
  status: AssignmentStatus;
  notes: string | null;
  created_by: string | null;
  created_at: string;
  updated_at: string;
}

export interface TekoContact {
  id: string;
  company_name: string;
  contact_name: string | null;
  phone: string | null;
  email: string | null;
  category: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

// ビュー用の型
export interface TekoDailySchedule {
  assignment_id: string;
  date: string;
  start_time: string | null;
  end_time: string | null;
  work_type: WorkType;
  status: AssignmentStatus;
  assignment_notes: string | null;
  worker_id: string;
  worker_name: string;
  worker_company: string | null;
  site_id: string;
  site_name: string;
  site_address: string | null;
  project_id: string | null;
}
```

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025-12-17 | 1.0 | 初版作成 |
