# TEKO-BOARD 技術設計書

**バージョン**: 1.0
**作成日**: 2025年12月17日
**最終更新**: 2025年12月17日

---

## 1. システムアーキテクチャ

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Vercel                                      │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                   TEKO-BOARD (Next.js 14)                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │
│  │  │   Pages     │  │   Server    │  │   Client    │               │  │
│  │  │  (App Dir)  │  │  Components │  │  Components │               │  │
│  │  │             │  │             │  │ (TimeChart) │               │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘               │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                               Port: 3001                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTPS
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Supabase (AGORA共有プロジェクト)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  PostgreSQL │  │    Auth     │  │   Storage   │  │  Realtime   │   │
│  │    (RLS)    │  │   (共有)    │  │             │  │ (将来対応)   │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Tables:                                                          │   │
│  │  ├── users (共有)         ├── teko_workers                       │   │
│  │  ├── clients (共有)       ├── teko_sites                         │   │
│  │  ├── projects (AGORA連携)  ├── teko_assignments                   │   │
│  │  └──                      └── teko_contacts                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 AGORAとの関係

```
┌───────────────────────────────────────────────────────────────────────┐
│                         同一Supabaseプロジェクト                        │
│                                                                         │
│   ┌─────────────────────┐         ┌─────────────────────┐            │
│   │       AGORA         │         │     TEKO-BOARD      │            │
│   │  (現場管理システム)   │         │  (人員配置管理)      │            │
│   │                     │         │                     │            │
│   │  localhost:3000     │         │  localhost:3001     │            │
│   │  /Users/ago/AGORA/  │         │  /Users/ago/teko-board/│          │
│   └──────────┬──────────┘         └──────────┬──────────┘            │
│              │                               │                        │
│              │     ┌─────────────────┐       │                        │
│              └────▶│   共有テーブル    │◀─────┘                        │
│                    │  users, clients │                                │
│                    │  projects       │                                │
│                    └─────────────────┘                                │
│                              ▲                                         │
│                              │ teko_sites.project_id                  │
│                    ┌─────────────────┐                                │
│                    │  TEKOテーブル    │                                │
│                    │  teko_*         │                                │
│                    └─────────────────┘                                │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 2. 技術スタック詳細

### 2.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js | 14.x (App Router) | フレームワーク |
| React | 18.x | UIライブラリ |
| TypeScript | 5.x | 型安全性 |
| Tailwind CSS | 3.x | スタイリング |
| shadcn/ui | latest | UIコンポーネント |
| React Query | 5.x | サーバー状態管理 |
| Zustand | 4.x | クライアント状態管理 |
| React Hook Form | 7.x | フォーム管理 |
| Zod | 3.x | バリデーション |
| date-fns | 3.x | 日付処理 |

### 2.2 TimeChart専用

| 技術 | 用途 |
|------|------|
| CSS Grid/Flexbox | タイムチャートレイアウト |
| Pointer Events API | ドラッグ&ドロップ |
| Touch Events API | スマートフォン対応 |
| requestAnimationFrame | スムーズなアニメーション |

### 2.3 バックエンド

| 技術 | 用途 |
|------|------|
| Supabase | BaaS (AGORA共有) |
| PostgreSQL | データベース |
| Row-Level Security (RLS) | 認可制御 |
| Supabase Auth | 認証 (AGORA共有) |

### 2.4 インフラ・ツール

| 技術 | 用途 |
|------|------|
| Vercel | ホスティング・デプロイ |
| GitHub | ソースコード管理 |
| Vitest | 単体テスト |
| Playwright | E2Eテスト |

---

## 3. ディレクトリ構成

```
teko-board/
├── .github/
│   └── workflows/
│       └── ci.yml
├── public/
│   └── favicon.ico
├── src/
│   ├── app/                      # App Router
│   │   ├── (auth)/               # 認証不要ページ
│   │   │   └── login/
│   │   │       └── page.tsx
│   │   ├── (dashboard)/          # 認証必要ページ（メイン）
│   │   │   ├── layout.tsx        # 共通レイアウト（BottomNav含む）
│   │   │   ├── page.tsx          # タイムチャート（メイン画面）
│   │   │   ├── schedule/
│   │   │   │   └── new/
│   │   │   │       └── page.tsx  # スケジュール追加
│   │   │   ├── sites/
│   │   │   │   ├── page.tsx      # 現場一覧
│   │   │   │   ├── new/
│   │   │   │   │   └── page.tsx  # 現場登録
│   │   │   │   └── [id]/
│   │   │   │       └── page.tsx  # 現場詳細
│   │   │   ├── contacts/
│   │   │   │   ├── page.tsx      # 連絡先一覧
│   │   │   │   └── new/
│   │   │   │       └── page.tsx  # 連絡先登録
│   │   │   ├── workers/
│   │   │   │   ├── page.tsx      # ワーカー管理
│   │   │   │   └── new/
│   │   │   │       └── page.tsx  # ワーカー登録
│   │   │   └── settings/
│   │   │       └── page.tsx      # 設定
│   │   ├── api/                  # API Routes（必要に応じて）
│   │   │   └── health/
│   │   │       └── route.ts
│   │   ├── layout.tsx            # ルートレイアウト
│   │   └── globals.css
│   ├── components/
│   │   ├── ui/                   # shadcn/ui コンポーネント
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   ├── dialog.tsx
│   │   │   ├── input.tsx
│   │   │   ├── select.tsx
│   │   │   └── ...
│   │   ├── layouts/              # レイアウトコンポーネント
│   │   │   ├── header.tsx
│   │   │   └── bottom-nav.tsx
│   │   ├── features/             # 機能別コンポーネント
│   │   │   ├── time-chart/       # タイムチャート
│   │   │   │   ├── index.ts
│   │   │   │   ├── time-chart.tsx
│   │   │   │   ├── week-chart.tsx
│   │   │   │   ├── time-chart-row.tsx
│   │   │   │   ├── schedule-item.tsx
│   │   │   │   ├── time-header.tsx
│   │   │   │   └── schedule-modal.tsx
│   │   │   ├── sites/            # 現場関連
│   │   │   │   ├── site-card.tsx
│   │   │   │   ├── site-form.tsx
│   │   │   │   └── site-list.tsx
│   │   │   ├── contacts/         # 連絡先関連
│   │   │   │   ├── contact-card.tsx
│   │   │   │   ├── contact-form.tsx
│   │   │   │   └── contact-list.tsx
│   │   │   ├── workers/          # ワーカー関連
│   │   │   │   ├── worker-card.tsx
│   │   │   │   ├── worker-form.tsx
│   │   │   │   └── worker-list.tsx
│   │   │   └── schedule/         # スケジュール関連
│   │   │       └── schedule-form.tsx
│   │   └── common/               # 共通コンポーネント
│   │       ├── date-picker.tsx
│   │       ├── view-toggle.tsx
│   │       ├── search-input.tsx
│   │       ├── status-badge.tsx
│   │       ├── work-type-badge.tsx
│   │       └── loading-spinner.tsx
│   ├── lib/
│   │   ├── supabase/
│   │   │   ├── client.ts         # ブラウザ用クライアント
│   │   │   ├── server.ts         # サーバー用クライアント
│   │   │   └── types.ts          # Supabase型定義
│   │   └── utils/
│   │       ├── date.ts           # 日付ユーティリティ
│   │       ├── time.ts           # 時間計算ユーティリティ
│   │       └── format.ts         # フォーマットユーティリティ
│   ├── hooks/
│   │   ├── use-workers.ts        # ワーカー取得
│   │   ├── use-sites.ts          # 現場取得
│   │   ├── use-assignments.ts    # 配置取得・更新
│   │   ├── use-contacts.ts       # 連絡先取得
│   │   └── use-auth.ts           # 認証状態
│   ├── stores/
│   │   ├── ui-store.ts           # UI状態（日付、ビューモード等）
│   │   └── schedule-store.ts     # スケジュール編集状態
│   ├── types/
│   │   ├── index.ts              # 型定義エントリポイント
│   │   ├── database.ts           # DB型定義
│   │   └── ui.ts                 # UI型定義
│   └── constants/
│       ├── work-types.ts         # 作業種別定義
│       └── config.ts             # 設定定数
├── docs/                         # ドキュメント
│   ├── 01_要件定義書.md
│   ├── 02_画面設計書.md
│   ├── 03_データベース設計書.md
│   └── 04_技術設計書.md
├── .env.local.example
├── CLAUDE.md                     # AI駆動開発用ルール
├── components.json               # shadcn/ui設定
├── next.config.js
├── package.json
├── tailwind.config.js
└── tsconfig.json
```

---

## 4. 認証・認可設計

### 4.1 認証フロー（AGORA共通）

```
┌─────────┐     ┌─────────────┐     ┌──────────────┐
│  User   │────▶│  Login Page │────▶│ Supabase Auth│
└─────────┘     └─────────────┘     └──────────────┘
                                            │
                                            ▼
                                    ┌──────────────┐
                                    │   JWT Token  │
                                    │   (Cookie)   │
                                    └──────────────┘
                                            │
                                            ▼
                                    ┌──────────────┐
                                    │  Middleware  │
                                    │  (認証確認)   │
                                    └──────────────┘
                                            │
                            ┌───────────────┴───────────────┐
                            ▼                               ▼
                    ┌──────────────┐               ┌──────────────┐
                    │    AGORA     │               │  TEKO-BOARD  │
                    │  (同じユーザー) │               │  (同じユーザー) │
                    └──────────────┘               └──────────────┘
```

### 4.2 Middleware実装

```typescript
// src/middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  // 未認証の場合はログインページへリダイレクト
  if (!session && !req.nextUrl.pathname.startsWith('/login')) {
    return NextResponse.redirect(new URL('/login', req.url));
  }

  // 認証済みでログインページにアクセスした場合はホームへ
  if (session && req.nextUrl.pathname.startsWith('/login')) {
    return NextResponse.redirect(new URL('/', req.url));
  }

  return res;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
};
```

### 4.3 RLSポリシー概要

TEKOテーブルのRLSポリシーは認証済みユーザー全員に読み取りを許可し、書き込みはロールベースで制御します。

```sql
-- 基本パターン: 認証済みユーザーは全員読み取り可能
CREATE POLICY "select_teko_*" ON teko_*
  FOR SELECT USING (auth.uid() IS NOT NULL);

-- 書き込みはロールベース（member以上）
CREATE POLICY "insert_teko_*" ON teko_*
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role IN ('admin', 'manager', 'member')
    )
  );
```

---

## 5. コンポーネント設計

### 5.1 TimeChart コンポーネント詳細

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         TimeChart Architecture                           │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│   TimeChart     │  ← メインコンテナ（日別）
│   (日別ビュー)   │
└────────┬────────┘
         │
         ├── TimeHeader        ← 時間軸ヘッダー (8:00, 9:00, ...)
         │
         ├── TimeChartRow[]    ← 会社/ワーカーごとの行
         │   │
         │   └── ScheduleItem[] ← 個別のスケジュールアイテム
         │       │
         │       ├── ドラッグハンドル（中央）
         │       ├── リサイズハンドル（左端）
         │       └── リサイズハンドル（右端）
         │
         └── CurrentTimeLine   ← 現在時刻の縦線

┌─────────────────┐
│   WeekChart     │  ← 週間ビュー
│   (週間ビュー)   │
└────────┬────────┘
         │
         ├── WeekHeader        ← 曜日ヘッダー (月, 火, 水, ...)
         │
         └── WeekChartRow[]    ← 会社/ワーカーごとの行
             │
             └── WeekScheduleItem[] ← 日ごとのスケジュール
```

### 5.2 ScheduleItem ドラッグ&ドロップ実装

```typescript
// src/components/features/time-chart/schedule-item.tsx

interface ScheduleItemProps {
  schedule: TekoAssignment;
  site: TekoSite;
  workTypeConfig: WorkTypeConfig;
  hourWidth: number;
  startHour: number;
  onTap?: (schedule: TekoAssignment) => void;
  onUpdate?: (schedule: TekoAssignment) => void;
  onDragStart?: (schedule: TekoAssignment, clientX: number, clientY: number) => void;
  isDragging?: boolean;
}

const SNAP_MINUTES = 15; // 15分単位でスナップ

export function ScheduleItem({
  schedule,
  site,
  workTypeConfig,
  hourWidth,
  startHour,
  onTap,
  onUpdate,
  onDragStart,
  isDragging,
}: ScheduleItemProps) {
  const [isResizing, setIsResizing] = useState<'start' | 'end' | null>(null);
  const itemRef = useRef<HTMLDivElement>(null);

  // 時間からピクセル位置を計算
  const timeToPixel = (time: string): number => {
    const [hours, minutes] = time.split(':').map(Number);
    return ((hours - startHour) * 60 + minutes) / 60 * hourWidth;
  };

  // ピクセルから時間を計算（スナップ付き）
  const pixelToTime = (px: number): string => {
    const totalMinutes = (px / hourWidth) * 60 + startHour * 60;
    const snappedMinutes = Math.round(totalMinutes / SNAP_MINUTES) * SNAP_MINUTES;
    const hours = Math.floor(snappedMinutes / 60);
    const minutes = snappedMinutes % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
  };

  const left = timeToPixel(schedule.start_time || '09:00');
  const right = timeToPixel(schedule.end_time || '18:00');
  const width = right - left;

  // ドラッグ開始ハンドラ
  const handleDragStart = (e: React.PointerEvent) => {
    if (isResizing) return;
    e.preventDefault();
    onDragStart?.(schedule, e.clientX, e.clientY);
  };

  // リサイズ開始ハンドラ
  const handleResizeStart = (edge: 'start' | 'end') => (e: React.PointerEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsResizing(edge);
    // リサイズ処理...
  };

  return (
    <div
      ref={itemRef}
      className={cn(
        'absolute h-full rounded px-1 py-0.5 cursor-grab text-white text-xs',
        'flex items-center overflow-hidden',
        isDragging && 'opacity-50',
      )}
      style={{
        left: `${left}px`,
        width: `${width}px`,
        backgroundColor: workTypeConfig.color,
      }}
      onPointerDown={handleDragStart}
      onClick={() => onTap?.(schedule)}
    >
      {/* 左リサイズハンドル */}
      <div
        className="absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize"
        onPointerDown={handleResizeStart('start')}
      />

      {/* コンテンツ */}
      <div className="flex-1 truncate">
        <div className="font-medium truncate">{site.name}</div>
        <div className="text-[10px] opacity-80">
          {schedule.start_time?.slice(0, 5)} - {schedule.end_time?.slice(0, 5)}
        </div>
      </div>

      {/* 右リサイズハンドル */}
      <div
        className="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize"
        onPointerDown={handleResizeStart('end')}
      />
    </div>
  );
}
```

### 5.3 状態管理（Zustand）

```typescript
// src/stores/ui-store.ts
import { create } from 'zustand';

interface UIState {
  // 日付関連
  selectedDate: Date;
  setSelectedDate: (date: Date) => void;
  goToPrevDay: () => void;
  goToNextDay: () => void;
  goToToday: () => void;

  // ビューモード
  viewMode: 'day' | 'week';
  setViewMode: (mode: 'day' | 'week') => void;

  // モーダル
  selectedScheduleId: string | null;
  setSelectedScheduleId: (id: string | null) => void;
}

export const useUIStore = create<UIState>((set) => ({
  selectedDate: new Date(),
  setSelectedDate: (date) => set({ selectedDate: date }),
  goToPrevDay: () =>
    set((state) => ({
      selectedDate: addDays(state.selectedDate, -1),
    })),
  goToNextDay: () =>
    set((state) => ({
      selectedDate: addDays(state.selectedDate, 1),
    })),
  goToToday: () => set({ selectedDate: new Date() }),

  viewMode: 'day',
  setViewMode: (mode) => set({ viewMode: mode }),

  selectedScheduleId: null,
  setSelectedScheduleId: (id) => set({ selectedScheduleId: id }),
}));
```

---

## 6. データフェッチ設計

### 6.1 Server Components でのデータ取得

```typescript
// src/app/(dashboard)/page.tsx
import { createClient } from '@/lib/supabase/server';
import { TimeChartContainer } from '@/components/features/time-chart';

export default async function TimeChartPage() {
  const supabase = await createClient();

  // ワーカー一覧取得
  const { data: workers } = await supabase
    .from('teko_workers')
    .select('*')
    .eq('is_active', true)
    .order('company_name');

  // 現場一覧取得
  const { data: sites } = await supabase
    .from('teko_sites')
    .select('*')
    .eq('is_active', true);

  return (
    <TimeChartContainer
      initialWorkers={workers || []}
      initialSites={sites || []}
    />
  );
}
```

### 6.2 React Query によるクライアント側データ管理

```typescript
// src/hooks/use-assignments.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { createClient } from '@/lib/supabase/client';

interface UseAssignmentsOptions {
  date?: string;
  workerId?: string;
  siteId?: string;
}

export function useAssignments(options: UseAssignmentsOptions = {}) {
  const supabase = createClient();

  return useQuery({
    queryKey: ['assignments', options],
    queryFn: async () => {
      let query = supabase
        .from('teko_assignments')
        .select(`
          *,
          worker:teko_workers(*),
          site:teko_sites(*)
        `)
        .order('date')
        .order('start_time');

      if (options.date) {
        query = query.eq('date', options.date);
      }
      if (options.workerId) {
        query = query.eq('worker_id', options.workerId);
      }
      if (options.siteId) {
        query = query.eq('site_id', options.siteId);
      }

      const { data, error } = await query;
      if (error) throw error;
      return data;
    },
    staleTime: 1000 * 60 * 5, // 5分間キャッシュ
  });
}

export function useUpdateAssignment() {
  const queryClient = useQueryClient();
  const supabase = createClient();

  return useMutation({
    mutationFn: async (assignment: Partial<TekoAssignment> & { id: string }) => {
      const { data, error } = await supabase
        .from('teko_assignments')
        .update(assignment)
        .eq('id', assignment.id)
        .select()
        .single();

      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['assignments'] });
    },
  });
}
```

### 6.3 日付範囲でのデータ取得（週間ビュー用）

```typescript
// src/hooks/use-week-assignments.ts
import { startOfWeek, endOfWeek, format } from 'date-fns';

export function useWeekAssignments(baseDate: Date) {
  const supabase = createClient();
  const weekStart = format(startOfWeek(baseDate, { weekStartsOn: 1 }), 'yyyy-MM-dd');
  const weekEnd = format(endOfWeek(baseDate, { weekStartsOn: 1 }), 'yyyy-MM-dd');

  return useQuery({
    queryKey: ['assignments', 'week', weekStart],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('teko_assignments')
        .select(`
          *,
          worker:teko_workers(*),
          site:teko_sites(*)
        `)
        .gte('date', weekStart)
        .lte('date', weekEnd)
        .order('date')
        .order('start_time');

      if (error) throw error;
      return data;
    },
  });
}
```

---

## 7. スタイリング設計

### 7.1 Tailwind CSS カスタム設定

```javascript
// tailwind.config.js
/** @type {import('tailwindcss').Config} */
module.exports = {
  darkMode: ["class"],
  content: [
    './src/**/*.{ts,tsx}',
  ],
  theme: {
    extend: {
      colors: {
        // 作業種別カラー
        'work-garbage': '#3B82F6',
        'work-management': '#22C55E',
        'work-interior': '#F97316',
        'work-demolition': '#EF4444',
        'work-electrical': '#EAB308',
      },
      // タイムチャート用のグリッドサイズ
      spacing: {
        'hour': '64px',        // 1時間の幅
        'row': '48px',         // 1行の高さ
        'label': '96px',       // ラベル列の幅
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
}
```

### 7.2 タイムチャート専用CSS

```css
/* src/app/globals.css */

/* タイムチャート横スクロール */
.time-chart-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
}

.time-chart-scroll::-webkit-scrollbar {
  height: 6px;
}

.time-chart-scroll::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

/* 現在時刻の線 */
.current-time-line {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 2px;
  background-color: #ef4444;
  z-index: 20;
  pointer-events: none;
}

.current-time-line::before {
  content: '';
  position: absolute;
  top: 0;
  left: -4px;
  width: 10px;
  height: 10px;
  background-color: #ef4444;
  border-radius: 50%;
}

/* ドラッグ中のスタイル */
.dragging {
  cursor: grabbing !important;
  user-select: none;
}

/* ドロップターゲットのハイライト */
.drop-target {
  background-color: rgba(59, 130, 246, 0.1);
}
```

---

## 8. 定数・設定

### 8.1 作業種別定義

```typescript
// src/constants/work-types.ts
import type { WorkType } from '@/types';

export interface WorkTypeConfig {
  label: string;
  color: string;
  hasWaste: boolean;  // ゴミ発生フラグ（Phase 2用）
}

export const WORK_TYPE_CONFIG: Record<WorkType, WorkTypeConfig> = {
  garbage: {
    label: 'ゴミ回収',
    color: '#3B82F6',
    hasWaste: false,
  },
  management: {
    label: '現場管理',
    color: '#22C55E',
    hasWaste: false,
  },
  interior: {
    label: '内装工事',
    color: '#F97316',
    hasWaste: true,
  },
  light_steel: {
    label: '軽量鉄骨',
    color: '#F97316',
    hasWaste: true,
  },
  board: {
    label: 'ボード',
    color: '#F97316',
    hasWaste: true,
  },
  wallpaper: {
    label: 'クロス',
    color: '#F97316',
    hasWaste: true,
  },
  tile_carpet: {
    label: 'タイルカーペット',
    color: '#F97316',
    hasWaste: true,
  },
  demolition: {
    label: '解体',
    color: '#EF4444',
    hasWaste: true,
  },
  electrical: {
    label: '電気工事',
    color: '#EAB308',
    hasWaste: false,
  },
  other: {
    label: 'その他',
    color: '#6B7280',
    hasWaste: false,
  },
};

export const WORK_TYPE_OPTIONS = Object.entries(WORK_TYPE_CONFIG).map(
  ([value, config]) => ({
    value: value as WorkType,
    label: config.label,
  })
);
```

### 8.2 アプリ設定

```typescript
// src/constants/config.ts

export const APP_CONFIG = {
  name: 'TEKO-BOARD',
  description: '人員配置管理システム',
  port: 3001,
};

export const TIME_CHART_CONFIG = {
  startHour: 0,      // 表示開始時間
  endHour: 24,       // 表示終了時間
  hourWidth: 64,     // 1時間の幅（px）
  rowHeight: 48,     // 1行の高さ（px）
  labelWidth: 96,    // ラベル列の幅（px）
  snapMinutes: 15,   // スナップ単位（分）
};

export const SUPABASE_CONFIG = {
  url: process.env.NEXT_PUBLIC_SUPABASE_URL!,
  anonKey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
};
```

---

## 9. エラーハンドリング

### 9.1 エラー種別

| コード | 種別 | 対応 |
|--------|------|------|
| 400 | バリデーションエラー | フォームにエラー表示 |
| 401 | 認証エラー | ログイン画面へリダイレクト |
| 403 | 権限エラー | エラートースト表示 |
| 404 | 存在しない | 404ページ表示 |
| 500 | サーバーエラー | エラーページ表示 |

### 9.2 エラーハンドリングユーティリティ

```typescript
// src/lib/utils/error.ts
import { toast } from 'sonner';

export function handleSupabaseError(error: unknown): void {
  console.error('Supabase error:', error);

  if (error && typeof error === 'object' && 'code' in error) {
    const supabaseError = error as { code: string; message: string };

    switch (supabaseError.code) {
      case 'PGRST301':
        toast.error('データが見つかりませんでした');
        break;
      case '23505':
        toast.error('データが重複しています');
        break;
      case '42501':
        toast.error('権限がありません');
        break;
      default:
        toast.error('エラーが発生しました');
    }
  } else {
    toast.error('エラーが発生しました');
  }
}
```

---

## 10. テスト戦略

### 10.1 テスト構成

```
tests/
├── unit/
│   ├── utils/
│   │   ├── date.test.ts
│   │   └── time.test.ts
│   └── components/
│       └── schedule-item.test.tsx
├── integration/
│   └── hooks/
│       └── use-assignments.test.ts
└── e2e/
    ├── time-chart.spec.ts
    └── schedule-crud.spec.ts
```

### 10.2 単体テスト例

```typescript
// tests/unit/utils/time.test.ts
import { describe, it, expect } from 'vitest';
import { timeToPixel, pixelToTime } from '@/lib/utils/time';

describe('timeToPixel', () => {
  it('converts time string to pixel position', () => {
    expect(timeToPixel('09:00', 64, 0)).toBe(576); // 9 * 64
    expect(timeToPixel('09:30', 64, 0)).toBe(608); // 9.5 * 64
  });
});

describe('pixelToTime', () => {
  it('converts pixel position to time string with 15min snap', () => {
    expect(pixelToTime(576, 64, 0, 15)).toBe('09:00');
    expect(pixelToTime(580, 64, 0, 15)).toBe('09:00'); // スナップ
    expect(pixelToTime(600, 64, 0, 15)).toBe('09:15');
  });
});
```

---

## 11. デプロイメント

### 11.1 環境

| 環境 | URL | 用途 |
|------|-----|------|
| Development | localhost:3001 | ローカル開発 |
| Preview | teko-*.vercel.app | PRプレビュー |
| Production | teko.ugoku.co.jp | 本番 |

### 11.2 環境変数

```env
# .env.local.example

# Supabase (AGORAと共通)
NEXT_PUBLIC_SUPABASE_URL=https://aotzgiaefbvbqhrguqdg.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx

# アプリ設定
NEXT_PUBLIC_APP_URL=http://localhost:3001
```

### 11.3 ビルド・デプロイコマンド

```bash
# 開発サーバー起動
npm run dev

# 本番ビルド
npm run build

# 本番サーバー起動
npm run start

# 型チェック
npm run type-check

# リント
npm run lint

# テスト
npm run test
```

---

## 12. 参考リンク

- [Next.js Documentation](https://nextjs.org/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [shadcn/ui](https://ui.shadcn.com/)
- [React Query](https://tanstack.com/query/latest)
- [Zustand](https://zustand-demo.pmnd.rs/)
- [Tailwind CSS](https://tailwindcss.com/docs)

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025-12-17 | 1.0 | 初版作成 |
